#!/usr/bin/env bash
set -e

MONITOR_WIDTH="${USAGE_MONITOR_WIDTH:-25}"
SESSION_NAME="${USAGE_MONITOR_SESSION:-monitor-$$}"

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if command -v usage-monitor &> /dev/null; then
    MONITOR_CMD="usage-monitor"
elif [[ -f "$SCRIPT_DIR/../dist/cli.js" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../dist/cli.js"
elif [[ -f "$SCRIPT_DIR/../src/cli/index.ts" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../src/cli/index.ts"
else
    echo "Error: usage-monitor not found. Run 'bun run build' first." >&2
    exit 1
fi

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] -- COMMAND [args...]

Run any command with usage monitor in a tmux side pane.

OPTIONS:
    -w, --width PERCENT   monitor pane width percentage (default: 25)
    -l, --left            put monitor on left (default: right)
    -s, --session NAME    tmux session name (default: monitor-PID)
    -h, --help            show this help

EXAMPLES:
    $(basename "$0") -- opencode
    $(basename "$0") -- nvim .
    $(basename "$0") -w 30 -- opencode --model opus
    $(basename "$0") -l -- zsh
    $(basename "$0") -s myproject -- opencode

ENVIRONMENT:
    USAGE_MONITOR_WIDTH     default pane width percentage
    USAGE_MONITOR_SESSION   default session name

REQUIREMENTS:
    - tmux (brew install tmux)
    - bun (curl -fsSL https://bun.sh/install | bash)
EOF
}

POSITION="right"

while [[ $# -gt 0 ]]; do
    case "$1" in
        -w|--width)
            MONITOR_WIDTH="$2"
            shift 2
            ;;
        -l|--left)
            POSITION="left"
            shift
            ;;
        -s|--session)
            SESSION_NAME="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -eq 0 ]]; then
    echo "Error: No command specified." >&2
    echo "" >&2
    usage >&2
    exit 1
fi

MAIN_CMD="$*"

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux is required but not installed." >&2
    echo "" >&2
    echo "Install with:" >&2
    echo "  macOS:  brew install tmux" >&2
    echo "  Ubuntu: sudo apt install tmux" >&2
    echo "  Fedora: sudo dnf install tmux" >&2
    exit 1
fi

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Session '$SESSION_NAME' already exists. Attaching..." >&2
    exec tmux attach-session -t "$SESSION_NAME"
fi

echo "Starting tmux session: $SESSION_NAME"
echo "  Command: $MAIN_CMD"
echo "  Monitor: ${POSITION} side (${MONITOR_WIDTH}%)"
echo ""

tmux new-session -d -s "$SESSION_NAME" "$MAIN_CMD"

if [[ "$POSITION" == "left" ]]; then
    tmux split-window -h -b -t "$SESSION_NAME" -l "${MONITOR_WIDTH}%" "$MONITOR_CMD"
    tmux select-pane -t "$SESSION_NAME:0.1"
else
    tmux split-window -h -t "$SESSION_NAME" -l "${MONITOR_WIDTH}%" "$MONITOR_CMD"
    tmux select-pane -t "$SESSION_NAME:0.0"
fi

exec tmux attach-session -t "$SESSION_NAME"

#!/usr/bin/env bash
set -e

SESSION_NAME="${USAGE_MONITOR_SESSION:-monitor-$$}"
HORIZONTAL_PANE_SIZE=25
VERTICAL_PANE_SIZE=15

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if command -v usage-monitor &> /dev/null; then
    MONITOR_CMD="usage-monitor"
elif [[ -f "$SCRIPT_DIR/../dist/cli.js" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../dist/cli.js"
elif [[ -f "$SCRIPT_DIR/../src/cli/index.ts" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../src/cli/index.ts"
else
    echo "Error: usage-monitor not found. Run 'bun run build' first." >&2
    exit 1
fi

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] -- COMMAND [args...]

Run any command with usage monitor in a tmux pane.

OPTIONS:
    -l, --left            put monitor on left (default: right)
    -r, --right           put monitor on right
    -t, --top             put monitor on top
    -b, --bottom          put monitor on bottom
    -s, --session NAME    tmux session name (default: monitor-PID)
    -h, --help            show this help

EXAMPLES:
    $(basename "$0") -- opencode
    $(basename "$0") -- nvim .
    $(basename "$0") -t -- opencode           # monitor on top
    $(basename "$0") -b -- opencode           # monitor on bottom
    $(basename "$0") -l -- zsh                # monitor on left
    $(basename "$0") -s myproject -- opencode

ENVIRONMENT:
    USAGE_MONITOR_SESSION   default session name

REQUIREMENTS:
    - tmux (brew install tmux)
    - bun (curl -fsSL https://bun.sh/install | bash)
EOF
}

POSITION="right"

while [[ $# -gt 0 ]]; do
    case "$1" in
        -l|--left)
            POSITION="left"
            shift
            ;;
        -r|--right)
            POSITION="right"
            shift
            ;;
        -t|--top)
            POSITION="top"
            shift
            ;;
        -b|--bottom)
            POSITION="bottom"
            shift
            ;;
        -s|--session)
            SESSION_NAME="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -eq 0 ]]; then
    echo "Error: No command specified." >&2
    echo "" >&2
    usage >&2
    exit 1
fi

MAIN_CMD="$*"

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux is required but not installed." >&2
    echo "" >&2
    echo "Install with:" >&2
    echo "  macOS:  brew install tmux" >&2
    echo "  Ubuntu: sudo apt install tmux" >&2
    echo "  Fedora: sudo dnf install tmux" >&2
    exit 1
fi

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Session '$SESSION_NAME' already exists. Attaching..." >&2
    exec tmux attach-session -t "$SESSION_NAME"
fi

echo "Starting tmux session: $SESSION_NAME"
echo "  Command: $MAIN_CMD"
echo "  Monitor: ${POSITION}"
echo ""

# Pane naming for easier identification and future toggle support
MAIN_PANE_NAME="main"
MONITOR_PANE_NAME="monitor"

# Wrapper to kill session when main command exits
# This ensures monitor terminates when the main command exits
WRAPPED_CMD="$MAIN_CMD; tmux kill-session -t '$SESSION_NAME' 2>/dev/null || true"

# Create main pane first
tmux new-session -d -s "$SESSION_NAME" "bash -c '$WRAPPED_CMD'"
tmux select-pane -t "$SESSION_NAME:0.0" -T "$MAIN_PANE_NAME"

# Split based on position
# -h = horizontal split (left/right), -v = vertical split (top/bottom)
# -b = put new pane before (left of / above)
case "$POSITION" in
    left)
        tmux split-window -h -b -t "$SESSION_NAME" -l "${HORIZONTAL_PANE_SIZE}%" "$MONITOR_CMD"
        tmux select-pane -t "$SESSION_NAME:0.0" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.1"
        ;;
    right)
        tmux split-window -h -t "$SESSION_NAME" -l "${HORIZONTAL_PANE_SIZE}%" "$MONITOR_CMD"
        tmux select-pane -t "$SESSION_NAME:0.1" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.0"
        ;;
    top)
        tmux split-window -v -b -t "$SESSION_NAME" -l "${VERTICAL_PANE_SIZE}%" "$MONITOR_CMD"
        tmux select-pane -t "$SESSION_NAME:0.0" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.1"
        ;;
    bottom)
        tmux split-window -v -t "$SESSION_NAME" -l "${VERTICAL_PANE_SIZE}%" "$MONITOR_CMD"
        tmux select-pane -t "$SESSION_NAME:0.1" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.0"
        ;;
esac

exec tmux attach-session -t "$SESSION_NAME"

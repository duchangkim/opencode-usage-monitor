#!/usr/bin/env bash
set -e

echo "╭────────────────────────────────────────╮"
echo "│   OpenCode Usage Monitor Setup         │"
echo "╰────────────────────────────────────────╯"
echo ""

check_command() {
    if command -v "$1" &> /dev/null; then
        echo "✓ $1 is installed"
        return 0
    else
        echo "✗ $1 is not installed"
        return 1
    fi
}

install_homebrew() {
    if ! command -v brew &> /dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
}

echo "Checking dependencies..."
echo ""

MISSING_DEPS=()

if ! check_command tmux; then
    MISSING_DEPS+=("tmux")
fi

if ! check_command bun; then
    MISSING_DEPS+=("bun")
fi

if ! check_command opencode; then
    MISSING_DEPS+=("opencode")
fi

echo ""

if [[ ${#MISSING_DEPS[@]} -eq 0 ]]; then
    echo "All dependencies are installed!"
    echo ""
    echo "You can now run:"
    echo "  opencode-with-monitor"
    echo ""
    exit 0
fi

echo "Missing dependencies: ${MISSING_DEPS[*]}"
echo ""

read -p "Would you like to install them? (y/n) " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "Manual installation commands:"
    for dep in "${MISSING_DEPS[@]}"; do
        case "$dep" in
            tmux)
                echo "  tmux:    brew install tmux"
                ;;
            bun)
                echo "  bun:     curl -fsSL https://bun.sh/install | bash"
                ;;
            opencode)
                echo "  opencode: bun install -g opencode"
                ;;
        esac
    done
    exit 1
fi

echo ""
echo "Installing dependencies..."
echo ""

OS="$(uname -s)"

for dep in "${MISSING_DEPS[@]}"; do
    case "$dep" in
        tmux)
            echo "Installing tmux..."
            if [[ "$OS" == "Darwin" ]]; then
                install_homebrew
                brew install tmux
            elif [[ "$OS" == "Linux" ]]; then
                if command -v apt &> /dev/null; then
                    sudo apt update && sudo apt install -y tmux
                elif command -v dnf &> /dev/null; then
                    sudo dnf install -y tmux
                elif command -v pacman &> /dev/null; then
                    sudo pacman -S tmux
                else
                    echo "Could not detect package manager. Please install tmux manually."
                    exit 1
                fi
            fi
            ;;
        bun)
            echo "Installing bun..."
            curl -fsSL https://bun.sh/install | bash
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            ;;
        opencode)
            echo "Installing opencode..."
            bun install -g opencode
            ;;
    esac
    echo ""
done

echo "╭────────────────────────────────────────╮"
echo "│   Setup Complete!                      │"
echo "╰────────────────────────────────────────╯"
echo ""
echo "Quick start:"
echo "  opencode-with-monitor"
echo ""
echo "Or with options:"
echo "  opencode-with-monitor -w 30    # wider monitor"
echo "  opencode-with-monitor -l       # monitor on left"
echo ""
echo "For more help:"
echo "  opencode-with-monitor --help"
echo ""

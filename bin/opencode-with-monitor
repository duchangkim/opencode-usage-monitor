#!/usr/bin/env bash
set -e

SESSION_NAME="${USAGE_MONITOR_SESSION:-opencode}"
HORIZONTAL_PANE_SIZE=25
VERTICAL_PANE_SIZE=15

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if command -v usage-monitor &> /dev/null; then
    MONITOR_CMD="usage-monitor"
elif [[ -f "$SCRIPT_DIR/../dist/cli.js" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../dist/cli.js"
elif [[ -f "$SCRIPT_DIR/../src/cli/index.ts" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../src/cli/index.ts"
else
    echo "Error: usage-monitor not found. Run 'bun run build' first." >&2
    exit 1
fi

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [-- opencode args...]

Start opencode with usage monitor in a tmux pane.

OPTIONS:
    -s, --session NAME    tmux session name (default: opencode)
    -l, --left            put monitor on left (default: right)
    -r, --right           put monitor on right
    -t, --top             put monitor on top
    -b, --bottom          put monitor on bottom
    -m, --monitor-only    only start the monitor, no opencode
    -a, --attach          attach to existing session if exists
    -k, --kill            kill existing session and start fresh
    -h, --help            show this help

EXAMPLES:
    $(basename "$0")                    # Start with defaults (monitor on right)
    $(basename "$0") -l                 # Monitor on left side
    $(basename "$0") -t                 # Monitor on top
    $(basename "$0") -b                 # Monitor on bottom
    $(basename "$0") -s myproject       # Custom session name
    $(basename "$0") -- --model opus    # Pass args to opencode
    $(basename "$0") -k                 # Kill existing and restart

ENVIRONMENT:
    USAGE_MONITOR_SESSION   default session name

REQUIREMENTS:
    - tmux (brew install tmux)
    - bun (curl -fsSL https://bun.sh/install | bash)
    - opencode (bun install -g opencode)
EOF
}

MONITOR_ONLY=false
ATTACH_EXISTING=false
KILL_EXISTING=false
POSITION="right"
OPENCODE_ARGS=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -s|--session)
            SESSION_NAME="$2"
            shift 2
            ;;
        -l|--left)
            POSITION="left"
            shift
            ;;
        -r|--right)
            POSITION="right"
            shift
            ;;
        -t|--top)
            POSITION="top"
            shift
            ;;
        -b|--bottom)
            POSITION="bottom"
            shift
            ;;
        -m|--monitor-only)
            MONITOR_ONLY=true
            shift
            ;;
        -a|--attach)
            ATTACH_EXISTING=true
            shift
            ;;
        -k|--kill)
            KILL_EXISTING=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            OPENCODE_ARGS="$*"
            break
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage >&2
            exit 1
            ;;
    esac
done

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux is required but not installed." >&2
    echo "" >&2
    echo "Install with:" >&2
    echo "  macOS:  brew install tmux" >&2
    echo "  Ubuntu: sudo apt install tmux" >&2
    echo "  Fedora: sudo dnf install tmux" >&2
    exit 1
fi

if ! command -v opencode &> /dev/null; then
    echo "Error: opencode is required but not installed." >&2
    echo "" >&2
    echo "Install with:" >&2
    echo "  bun install -g opencode" >&2
    exit 1
fi

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    if [[ "$KILL_EXISTING" == true ]]; then
        echo "Killing existing session: $SESSION_NAME"
        tmux kill-session -t "$SESSION_NAME"
    elif [[ "$ATTACH_EXISTING" == true ]]; then
        echo "Attaching to existing session: $SESSION_NAME"
        exec tmux attach-session -t "$SESSION_NAME"
    else
        echo "Session '$SESSION_NAME' already exists." >&2
        echo "  Use -a to attach, -k to kill and restart" >&2
        exit 1
    fi
fi

echo "Starting tmux session: $SESSION_NAME"
echo "  Monitor position: ${POSITION}"
echo ""

# Pane naming for easier identification and future toggle support
MAIN_PANE_NAME="main"
MONITOR_PANE_NAME="monitor"

# Wrapper script to kill session when main command exits
# This ensures monitor terminates when opencode exits
create_main_wrapper() {
    local cmd="$1"
    # Execute command, then kill the tmux session when it exits
    echo "$cmd; tmux kill-session -t '$SESSION_NAME' 2>/dev/null || true"
}

if [[ "$MONITOR_ONLY" == true ]]; then
    tmux new-session -d -s "$SESSION_NAME" "$MONITOR_CMD"
    tmux select-pane -t "$SESSION_NAME:0.0" -T "$MONITOR_PANE_NAME"
else
    OPENCODE_CMD="opencode $OPENCODE_ARGS"
    WRAPPED_CMD=$(create_main_wrapper "$OPENCODE_CMD")
    
    # Create main pane first
    tmux new-session -d -s "$SESSION_NAME" "bash -c '$WRAPPED_CMD'"
    tmux select-pane -t "$SESSION_NAME:0.0" -T "$MAIN_PANE_NAME"
    
    # Split based on position
    # -h = horizontal split (left/right), -v = vertical split (top/bottom)
    # -b = put new pane before (left of / above)
    case "$POSITION" in
        left)
            tmux split-window -h -b -t "$SESSION_NAME" -l "${HORIZONTAL_PANE_SIZE}%" "$MONITOR_CMD"
            tmux select-pane -t "$SESSION_NAME:0.0" -T "$MONITOR_PANE_NAME"
            tmux select-pane -t "$SESSION_NAME:0.1"
            ;;
        right)
            tmux split-window -h -t "$SESSION_NAME" -l "${HORIZONTAL_PANE_SIZE}%" "$MONITOR_CMD"
            tmux select-pane -t "$SESSION_NAME:0.1" -T "$MONITOR_PANE_NAME"
            tmux select-pane -t "$SESSION_NAME:0.0"
            ;;
        top)
            tmux split-window -v -b -t "$SESSION_NAME" -l "${VERTICAL_PANE_SIZE}%" "$MONITOR_CMD"
            tmux select-pane -t "$SESSION_NAME:0.0" -T "$MONITOR_PANE_NAME"
            tmux select-pane -t "$SESSION_NAME:0.1"
            ;;
        bottom)
            tmux split-window -v -t "$SESSION_NAME" -l "${VERTICAL_PANE_SIZE}%" "$MONITOR_CMD"
            tmux select-pane -t "$SESSION_NAME:0.1" -T "$MONITOR_PANE_NAME"
            tmux select-pane -t "$SESSION_NAME:0.0"
            ;;
    esac
fi

exec tmux attach-session -t "$SESSION_NAME"

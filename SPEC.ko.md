# Agentic Usage Monitor - 기술 명세서

> **원본 문서**: [English Version](./SPEC.md)  
> **주의**: 이 문서는 영어 원본의 번역본입니다. 원본 업데이트 시 이 문서도 함께 업데이트해야 합니다.

## 1. 개요

**Agentic Usage Monitor**는 AI 코딩 에이전트의 사용량과 Rate Limit을 터미널에서 실시간으로 모니터링하는 도구입니다. tmux를 사용하여 터미널 기반 AI 코딩 어시스턴트(OpenCode, Claude Code 등)와 함께 실행되며, 개발 워크플로우를 방해하지 않고 사용량을 지속적으로 확인할 수 있습니다.

### 프로젝트 정보

- **현재 이름**: `opencode-usage-monitor`
- **목표 이름**: `agentic-usage-monitor`
- **CLI 명령어**: `usage-monitor`
- **패키지**: `agentic-usage-monitor` (npm/bun)

## 2. 문제 정의

터미널에서 AI 코딩 에이전트를 사용하는 개발자들이 겪는 문제:

1. **보이지 않는 Rate Limit**: 터미널을 떠나지 않고는 현재 사용량을 알기 어려움
2. **예상치 못한 제한**: 갑자기 Rate Limit에 도달하여 개발 흐름이 끊김
3. **컨텍스트 스위칭**: 사용량 확인을 위해 브라우저/앱으로 전환 필요
4. **일시적 정보**: 사용량 정보가 지속적으로 표시되지 않음

### 현재 해결책의 한계

| 해결책                     | 문제점                          |
| -------------------------- | ------------------------------- |
| claude.ai 설정 페이지 확인 | 브라우저로 컨텍스트 스위칭 필요 |
| Rate Limit 에러 대기       | 반응적, 능동적이지 않음         |
| 직감으로 추정              | 부정확, 불안감 유발             |

## 3. 목표

### 주요 목표

1. **실시간 가시성**: 터미널에서 Rate Limit 사용량을 지속적으로 표시
2. **무중단**: 코딩 워크플로우를 방해하지 않고 모니터링
3. **유연한 배치**: 사용자가 원하는 위치에 모니터 표시 (상/하/좌/우)
4. **컴팩트 모드**: 터미널 사용을 방해하지 않는 최소한의 한 줄 표시

### 부가 목표

1. **OpenCode 통합**: OpenCode 플러그인 우선 지원
2. **확장 가능한 아키텍처**: 향후 다른 AI 에이전트 지원을 위한 Provider 인터페이스
3. **간편한 설정**: 한 줄 명령으로 설치 및 설정

### 성공 지표

- 터미널을 떠나지 않고 현재 사용량을 한눈에 확인 가능
- 모니터 시작 시간 < 2초
- 새로고침 완료 시간 < 1초
- macOS와 Linux에서 동작

## 4. 비목표 (Non-Goals)

다음 항목은 명시적으로 **범위 외**입니다:

| 비목표                    | 이유                                                  |
| ------------------------- | ----------------------------------------------------- |
| Admin API / 조직 빌링     | 복잡도 감소; 개인 Rate Limit에 집중                   |
| GUI/데스크톱 애플리케이션 | 터미널 네이티브 도구; GUI는 Claude-Usage-Tracker 존재 |
| tmux 외 터미널 멀티플렉서 | tmux가 가장 보편적; 나머지는 추후 추가 가능           |
| 실시간 토큰 카운팅        | API 호출 인터셉트 필요; 프라이버시 우려               |
| v1에서 멀티 프로바이더    | Claude에 먼저 집중; 아키텍처는 확장 지원              |

## 5. 타겟 사용자

### 주요: OpenCode 사용자

[OpenCode](https://github.com/opencode-ai/opencode)를 터미널 기반 AI 코딩 어시스턴트로 사용하는 개발자.

**특징**:

- 터미널과 tmux에 익숙함
- Claude (Pro/Max) 구독 사용
- Rate Limit의 지속적인 가시성 원함
- 키보드 중심 워크플로우 선호

### 부가: Claude Code 사용자

Anthropic의 공식 Claude Code CLI를 사용하는 개발자.

**참고**: Claude Code 확장은 아키텍처적으로 계획되었으나 v1에서는 우선순위가 낮음.

## 6. 핵심 기능

### 6.1 Rate Limit 표시

**목표**: 사용자가 현재 Rate Limit 상태를 한눈에 확인할 수 있어야 함.

**필수 정보**:

- 각 Rate Limit 윈도우(5시간, 7일 등)의 현재 사용률 %
- 각 윈도우 리셋까지 남은 시간
- 사용자 프로필 정보 (이름, 조직, 플랜 유형)

**설계 원칙**: 정보는 인지적 부담 없이 즉시 이해할 수 있어야 함.

### 6.2 표시 모드

#### Pane 모드

**목표**: 상세한 사용량 정보를 위한 전용 공간.

- 사용자가 모니터 pane을 원하는 방향에 배치 가능 (상/하/좌/우)
- Pane 크기 설정 가능
- 메인 터미널 워크플로우를 방해하지 않아야 함

#### 컴팩트 모드 (Status Bar)

**목표**: 터미널 사용을 방해하지 않는 최소한의 한 줄 표시.

- tmux status bar에 필수 사용량 정보 표시
- 눈에 거슬리지 않으면서도 한눈에 확인 가능해야 함
- 컨텍스트 스위칭 없이 빠르게 사용량 확인 가능해야 함

### 6.3 OpenCode 플러그인

**목표**: 사용자가 OpenCode 내에서 자연스러운 명령으로 모니터를 제어할 수 있어야 함.

**필수 기능**:

- 모니터 가시성 토글 (표시/숨기기)
- 현재 상태 확인
- 설정 도움말 제공

**설계 원칙**: 슬래시 명령과 에이전트에 대한 자연어 요청 모두 동작해야 함.

### 6.4 런처 스크립트

**목표**: 모니터가 미리 설정된 상태로 한 줄 명령으로 시작.

**필수 기능**:

- 모니터가 이미 표시된 상태로 OpenCode (또는 다른 명령) 시작
- 명령줄 옵션으로 위치와 크기 설정
- 기존 세션 충돌을 우아하게 처리

### 6.5 설정

**목표**: 파워 유저를 위한 커스터마이징 옵션과 함께 합리적인 기본값 제공.

**설정 가능 항목**:

- 새로고침 간격
- 표시 위치와 모드
- 시각적 스타일 설정
- 프로필 표시 옵션

**설계 원칙**: 대부분의 사용자에게는 설정 없이 동작해야 함.

## 7. 아키텍처

### 7.1 컴포넌트 개요

```
┌─────────────────────────────────────────────────────────────┐
│                    agentic-usage-monitor                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐     ┌─────────────────────────────┐    │
│  │   CLI           │     │   OpenCode Plugin           │    │
│  │   (독립 실행)     │◄────│   (tmux 제어)                │    │
│  └────────┬────────┘     └─────────────────────────────┘    │
│           │                                                 │
│  ┌────────▼────────┐     ┌─────────────────────────────┐    │
│  │   Monitor Core  │────►│   Provider Interface        │    │
│  │   (스케줄링,      │     │                             │    │
│  │    상태 관리)     │     │   - Claude Provider (v1)    │    │
│  └─────────────────┘     │   - 향후 프로바이더...          │    │
│                          └─────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 Provider 인터페이스

**목표**: 대규모 리팩토링 없이 향후 여러 AI 에이전트 프로바이더 지원 가능하게 함.

**설계 원칙**:

- 각 프로바이더는 자체 인증과 API 통신 처리
- 프로바이더와 관계없이 사용량 데이터에 대한 공통 인터페이스
- v1은 Claude만 구현; 가상의 프로바이더를 위한 과도한 설계 지양

### 7.3 데이터 흐름

```
Credentials → Provider → Monitor Core → Renderer (TUI)
                              ↑
                           Config
```

## 8. 기술적 제약

### 8.1 요구사항

| 요구사항          | 명세                                 |
| ----------------- | ------------------------------------ |
| 런타임            | Bun (Node.js 호환)                   |
| 터미널 멀티플렉서 | tmux (필수)                          |
| OS                | macOS, Linux                         |
| 인증              | OpenCode/Claude Code OAuth 자격 증명 |

### 8.2 의존성

**설계 원칙**: 의존성 최소화. 꼭 필요한 것만 추가.

| 카테고리    | 패키지              | 용도            |
| ----------- | ------------------- | --------------- |
| 유효성 검사 | zod                 | 설정/응답 검증  |
| 플러그인    | @opencode-ai/plugin | OpenCode 통합   |
| 개발        | typescript, biome   | 타입 체크, 린팅 |

### 8.3 자격 증명 소스

OAuth 자격 증명 우선순위:

1. **OpenCode**: `~/.local/share/opencode/auth.json`
2. **Claude Code**: `~/.claude/.credentials.json`
3. **테스트**: `TEST_CREDENTIALS_PATH` 환경 변수

## 9. 제거된 기능

현재 구현에서 다음 기능들이 **제거**됩니다:

### Admin API 통합

**이유**: 복잡도 감소. 개인 Rate Limit에 집중.

**제거되는 컴포넌트**:

- `src/data/admin-api.ts`
- `--api-only` CLI 플래그
- 조직 빌링/비용 표시
- `ANTHROPIC_ADMIN_API_KEY` 지원

**마이그레이션**: 조직 빌링이 필요한 사용자는 Anthropic Console이나 다른 도구 사용.

## 10. 구현 단계

### Phase 1: 코어 정리 (현재 → v1.0)

- [x] Admin API 컴포넌트 제거
- [x] 설정 단순화 (admin 관련 옵션 제거)
- [x] 문서 업데이트
- [x] 프로젝트 이름 변경: `agentic-usage-monitor`

### Phase 2: 위치 기능 강화 (v1.1)

- [ ] 상/하 위치 지원 추가
- [ ] pane용 컴팩트 모드 구현
- [ ] tmux status bar 통합 추가

### Phase 3: 완성도 개선 (v1.2)

- [ ] 사용량 추이 표시 (선택사항)
- [ ] 테마 커스터마이징
- [ ] 알림 지원 (임계값 알림)

### Phase 4: 확장성 (v2.0)

- [ ] Provider 인터페이스 공식화
- [ ] 프로바이더 추가를 위한 문서
- [ ] 수요가 있으면 OpenAI/Gemini 고려

## 11. 미결정 사항

| 질문                         | 상태 | 참고                        |
| ---------------------------- | ---- | --------------------------- |
| Status bar 포맷 커스터마이징 | TBD  | 얼마나 유연하게?            |
| 멀티 프로바이더 표시         | TBD  | 전부 표시 vs 활성화된 것만? |
| 알림 메커니즘                | TBD  | 터미널 벨? 데스크톱 알림?   |
| 사용량 히스토리/추이         | TBD  | 로컬 저장? 얼마나?          |

## 12. 참고 문서

- [AGENTS.md](./AGENTS.md) - AI 에이전트 지침
- [Claude-Usage-Tracker](https://github.com/hamed-elfayome/Claude-Usage-Tracker) - 참고 macOS 앱
- [OpenCode](https://github.com/opencode-ai/opencode) - 주요 통합 대상

---

**문서 버전**: 1.0  
**최종 업데이트**: 2026-02-01  
**작성자**: 프로젝트 관리자
